{% extends 'adminbase.html.twig' %}

{% block title %}Activity Logs{% endblock %}

{% block body %}
<div class="max-w-7xl mx-auto mt-10 p-6 bg-white shadow-md rounded-lg">
    <div class="flex justify-between items-center mb-6 helvetica-condensed">
        <h1 class="text-2xl font-bold">Activity Logs</h1>
    </div>

    <div class="mb-6 p-4 bg-gray-50 rounded-lg helvetica-condensed">
        <form method="get" action="{{ path('activity_log_index') }}" class="grid grid-cols-1 lg:grid-cols-5 gap-3 items-end">

            <div class="lg:col-span-2 flex-1 min-w-0">
                <label class="block text-sm font-medium text-gray-700 mb-1">User Search</label>
                <input type="text" name="userSearch" value="{{ app.request.query.get('userSearch') }}"
                       placeholder="Search by username"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
            </div>

            <div class="flex-1 min-w-0">
                <label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
                <select name="action" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">All Actions</option>
                    {% set actions = ['LOGIN','LOGOUT','USER_CREATE','USER_EDIT','USER_DELETE','USER_DISABLE','USER_ENABLE','ROOM_CREATE','ROOM_EDIT','ROOM_DELETE','BOOKING_CREATE','BOOKING_UPDATE','BOOKING_DELETE','BOOKING_CHECKIN','BOOKING_CHECKOUT','BOOKING_HISTORY_EDIT','BOOKING_HISTORY_DELETE'] %}
                    {% for a in actions %}
                        <option value="{{ a }}" {{ app.request.query.get('action') == a ? 'selected' : '' }}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="flex-1 min-w-0">
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date" name="startDate" value="{{ app.request.query.get('startDate') }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
            </div>

            <div class="flex-1 min-w-0">
                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date" name="endDate" value="{{ app.request.query.get('endDate') }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
            </div>

            <div class="flex gap-2 flex-1 min-w-0 justify-end">
                <button type="submit" class="bg-[rgb(29,53,153)] text-white px-3 py-2 rounded-md hover:bg-[rgb(242,182,34)] transition text-sm whitespace-nowrap">
                    Apply
                </button>
                <a href="{{ path('activity_log_index') }}" class="bg-gray-500 text-white rounded-md px-3 py-2 hover:bg-gray-600 transition text-sm whitespace-nowrap text-center flex items-center justify-center">
                    Clear
                </a>
            </div>

        </form>
    </div>

    <div class="mb-4 helvetica-condensed mt-5">
        <p class="text-sm text-gray-600">
            Showing {{ logs|length }} of {{ total }} log(s)
            {% if app.request.query.get('user') or app.request.query.get('action') or app.request.query.get('startDate') or app.request.query.get('endDate') %}
                (filtered)
            {% endif %}
        </p>
    </div>

    <div class="helvetica-condensed overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">View</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for log in logs %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ log.createdAt|date('Y-m-d H:i:s') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ log.username ?? 'N/A' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ log.role ?? '-' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ log.action }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if log.entityType %}
                                {{ log.entityType }}{% if log.entityId %} #{{ log.entityId }}{% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm truncate max-w-xs">{{ log.description|default('-') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <a href="{{ path('activity_log_show', {'id': log.id}) }}" class="text-blue-600 hover:underline">Details</a>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="7" class="helvetica-condensed px-6 py-4 text-center text-red-600">
                            {% if app.request.query.get('user') or app.request.query.get('action') or app.request.query.get('startDate') or app.request.query.get('endDate') %}
                                No logs found matching your filters.
                            {% else %}
                                No logs found.
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Pagination #}
    {% if totalPages > 1 %}
    <div class="mt-6 flex justify-center items-center space-x-1 helvetica-condensed">
        {% if currentPage > 1 %}
            <a href="{{ path('activity_log_index', app.request.query.all|merge({ page: currentPage - 1 })) }}" 
               class="px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-100">←</a>
        {% endif %}

        {% for p in max(1, currentPage - 2)..min(totalPages, currentPage + 2) %}
            {% if p == currentPage %}
                <span class="px-3 py-1 rounded bg-blue-600 text-white text-sm">{{ p }}</span>
            {% else %}
                <a href="{{ path('activity_log_index', app.request.query.all|merge({ page: p })) }}" 
                   class="px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-100">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if currentPage < totalPages %}
            <a href="{{ path('activity_log_index', app.request.query.all|merge({ page: currentPage + 1 })) }}" 
               class="px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-100">→</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
