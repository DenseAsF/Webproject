{% extends 'adminbase.html.twig' %}

{% block title %}Edit Booking #{{ booking.id }}{% endblock %}

{% block body %}
<div class="max-w-2xl mx-auto mt-10 p-6 bg-white shadow-md rounded-lg helvetica-condensed">
    <h2 class="text-2xl font-bold mb-6">Edit Booking #{{ booking.id }}</h2>

    {% for message in app.flashes('error') %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            {{ message }}
        </div>
    {% endfor %}

    {% for message in app.flashes('success') %}
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
            {{ message }}
        </div>
    {% endfor %}

    {{ form_start(form, {
        'attr': {
            'class': 'space-y-6', 
            'id': 'booking-form',
            'data-turbo': 'false'
        }, 
        'novalidate': 'novalidate'
    }) }}

    <div>
        {{ form_label(form.customerAccountNumber) }}
        {{ form_widget(form.customerAccountNumber, {'attr': {'class':'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500'}}) }}
        {{ form_errors(form.customerAccountNumber) }}
    </div>

    <div>
        {{ form_label(form.checkInDate) }}
        {{ form_widget(form.checkInDate, {'attr': {'class':'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500'}}) }}
        {{ form_errors(form.checkInDate) }}
    </div>

    <div>
        {{ form_label(form.checkOutDate) }}
        {{ form_widget(form.checkOutDate, {'attr': {'class':'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500'}}) }}
        {{ form_errors(form.checkOutDate) }}
    </div>

    <div class="flex items-center gap-2">
        <div class="flex-1">
            <label for="roomsDropdown" class="block text-sm font-medium text-gray-700">Room</label>
            
            <select id="roomsDropdown" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="">Click "Look for Rooms" to see available rooms</option>
            </select>
            
            {{ form_widget(form.roomId, {'attr': {'id': 'roomId', 'class': 'hidden'}}) }}
        </div>
        <div class="mt-6">
            <button type="button" id="lookRoomsBtn" class="bg-blue-700 text-white px-4 py-2 rounded-md hover:bg-yellow-500 transition-colors">
                Look for Rooms
            </button>
        </div>
    </div>

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Services</label>
        <div class="mt-2 space-y-2" id="servicesContainer">
            {% for service in services %}
                <div class="flex items-center">
                    <input type="checkbox" 
                           id="service_{{ service.id }}" 
                           name="services[]" 
                           value="{{ service.id }}"
                           class="service-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                           data-price="{{ service.price }}"
                           {% for bookingService in booking.bookingServices %}
                               {% if bookingService.service.id == service.id %}checked{% endif %}
                           {% endfor %}>
                    <label for="service_{{ service.id }}" class="ml-2 text-sm text-gray-700">
                        {{ service.name }} - ₱{{ service.price|number_format(2) }}
                    </label>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="flex gap-4 mt-8">
        <button type="submit" class="flex-1 bg-[rgb(29,53,153)] text-white py-3 px-4 rounded-md hover:bg-[rgb(242,182,34)] transition-colors font-medium">
            Update Booking
        </button>
        <a href="{{ path('booking_index', {'id': booking.id}) }}" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-md hover:bg-gray-600 transition-colors font-medium flex items-center justify-center no-underline">
            Cancel
        </a>
    </div>

    {{ form_end(form) }}
</div>

<script>
function initBookingEditPage() {
    const checkInInput = document.querySelector('#{{ form.checkInDate.vars.id }}');
    const checkOutInput = document.querySelector('#{{ form.checkOutDate.vars.id }}');
    const roomsDropdown = document.getElementById('roomsDropdown');
    const roomIdInput = document.querySelector('#{{ form.roomId.vars.id }}');
    const lookRoomsBtn = document.getElementById('lookRoomsBtn');
    
    // Pre-select the current room
    const currentRoomId = '{{ booking.room.id }}';
    if (currentRoomId) {
        // Add current room to dropdown
        const currentRoomOption = document.createElement('option');
        currentRoomOption.value = currentRoomId;
        currentRoomOption.textContent = 'Room {{ booking.room.roomNumber }} - ₱{{ booking.room.price|number_format(2) }} (Current)';
        currentRoomOption.selected = true;
        roomsDropdown.appendChild(currentRoomOption);
        roomIdInput.value = currentRoomId;
    }

    lookRoomsBtn.addEventListener('click', async function() {
        const checkIn = checkInInput.value;
        const checkOut = checkOutInput.value;

        if (!checkIn || !checkOut) {
            alert('Please select both check-in and check-out dates first.');
            return;
        }

        if (new Date(checkOut) <= new Date(checkIn)) {
            alert('Check-out date must be after check-in date.');
            return;
        }

        const url = `{{ path('booking_available_rooms') }}?checkIn=${encodeURIComponent(checkIn)}&checkOut=${encodeURIComponent(checkOut)}`;

        try {
            lookRoomsBtn.disabled = true;
            lookRoomsBtn.textContent = 'Searching...';

            const response = await fetch(url, { 
                headers: { 
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                } 
            });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            
            // Clear dropdown but keep current room option
            roomsDropdown.innerHTML = '';
            if (currentRoomId) {
                const currentRoomOption = document.createElement('option');
                currentRoomOption.value = currentRoomId;
                currentRoomOption.textContent = 'Room {{ booking.room.roomNumber }} - ₱{{ booking.room.price|number_format(2) }} (Current)';
                currentRoomOption.selected = true;
                roomsDropdown.appendChild(currentRoomOption);
            } else {
                roomsDropdown.innerHTML = '<option value="">Select a room...</option>';
            }

            if (!data.rooms || data.rooms.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No rooms available for selected dates';
                roomsDropdown.appendChild(option);
            } else {
                data.rooms.forEach(function(room) {
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = room.label;
                    roomsDropdown.appendChild(option);
                });
            }
            
            roomsDropdown.disabled = false;
            
        } catch (err) {
            console.error('Error:', err);
            alert('Error fetching available rooms.');
        } finally {
            lookRoomsBtn.disabled = false;
            lookRoomsBtn.textContent = 'Look for Rooms';
        }
    });

    roomsDropdown.addEventListener('change', function() {
        roomIdInput.value = this.value;
    });
}

// Support both full page loads and Turbo-powered navigation
document.addEventListener('DOMContentLoaded', initBookingEditPage);
document.addEventListener('turbo:load', initBookingEditPage);
</script>
{% endblock %}